## 要件定義書 (簡易版)

### 1. アプリ名 (仮)
DevCard — エンジニアのためのデジタル名刺

### 2. 目的
従来のビジネス用名刺は、エンジニア同士のカジュアルな技術交流には適していない。
DevCardは、GitHub/Qiita/Zennなどの技術発信情報を自動で集約し、「エンジニア文化」に特化したデジタル名刺を「1つのURL」で高速に共有・閲覧できる体験を実現する。

### 3. 対象ユーザー
* 勉強会、ハッカソン、登壇などで活動するエンジニア
* 技術発信を行う学生、個人開発者
* ポートフォリオ共有を簡略化したい層

### 4. 主な機能要件

#### 4.1 認証
* 以下のプロバイダでログインできる：
    * **Apple Sign In** (iOS必須要件)
    * **Google Sign In**
    * **GitHub OAuth**
    * **X (Twitter) OAuth**
* メールアドレス/パスワードでの登録も可能（バックアップ用）

#### 4.2 PublicCard（公開名刺）
* **目的**: 技術的なアウトプットを共有するための公開プロフィール
* **配布方法**: URLで誰にでも、いつでも共有可能
* **用途**: 登壇スライド、SNSプロフィール、ポートフォリオサイト
* **表示内容**:
    * 連携サービス（GitHub等）から公開情報を取得し、デジタル名刺を自動生成
    * GitHub: リポジトリ、スター数、貢献グラフ
    * Qiita/Zenn: 記事一覧、いいね数
    * プロフィール画像、自己紹介
* **カスタマイズ**: 名刺のデザインをCSS編集などでカスタマイズできる
* **データ同期**:
    * 連携サービス（GitHub等）の最新情報を自動で名刺に反映する (自動同期)
    * ユーザーが任意のタイミングで「今すぐ同期」できる (手動同期)
* **Webでの閲覧**: 相手がアプリを持っていなくても、Webブラウザ（公開URL）だけで名刺を閲覧できる
* **共有 (Web)**: Web名刺ページにQRコードを表示でき、LINEやX (Twitter) でシェアした際にリッチなプレビュー (OGP) が表示される
* **有効期限**: なし（永続）

#### 4.3 PrivateCard（個人連絡先交換）
* **目的**: リアルで会った人とだけ、より深い個人連絡先を交換する
* **配布方法**: 物理的に近くにいる時のみ交換可能
    * AirDrop（iOS同士）
    * NFC / Bluetooth（将来実装）
    * QRコード + 1分間の有効期限
* **用途**: 勉強会、イベント、ハッカソンでの出会い
* **表示内容**:
    * 個人メールアドレス
    * 電話番号
    * LINE ID
    * Discord ID
    * プライベートSNSアカウント
    * その他、ユーザーが設定した個人連絡先
* **有効期限**: トークン発行から1分間、または1回受け取りまで
* **セキュリティ**:
    * トークンは使い捨て（ワンタイム）
    * 自分で自分のトークンは使えない
    * 期限切れトークンは自動削除
* **価値**: 「会う価値」を生み出す。URLで交換できるなら会う必要がないが、PrivateCardは会わないと交換できない。

#### 4.4 画像アップロード
* **目的**: プロフィール画像や名刺背景をカスタマイズする
* **アップロード可能な画像**:
    * プロフィール画像
    * 名刺背景画像
* **保存先**: Firebase Storage
* **制限**:
    * 本人のみアップロード可能
    * 全員が閲覧可能（公開画像として）
    * サイズ制限あり（例: 5MB以内）

#### 4.5 イベント機能
* **目的**: 「この人とはこのイベントで会った」を記録・管理
* **主な機能**:
    * イベントに「参加中」としてチェックイン
    * 同じイベント参加者の一覧表示
    * 同じイベント参加者にワンタップでPublicCard送信
    * イベントごとに交換した名刺をまとめて表示
    * 「この人とはあのイベントで会った」履歴の確認
* **データ**:
    * イベント名、日時、場所
    * 参加者リスト
    * イベントでの名刺交換履歴

#### 4.6 バッジ機能
* **目的**: 所属、資格、称号などのステータスを名刺に表示
* **バッジの種類**:
    * **会社・組織**: 会社ロゴ、所属コミュニティ
    * **資格・認定**: AWS認定、応用情報技術者など
    * **称号**: Kaggleランク、GitHubスター数
    * **カスタム**: ユーザーが自由に作成
* **表示方法**:
    * PublicCard/PrivateCardに自由に配置可能
    * 認証済みバッジはCSS編集不可の固定位置に表示（信頼性担保）
    * 未認証バッジはユーザーが自由配置
* **認証**:
    * 運営が公式認証バッジを発行（verified: true）
    * ユーザーは未認証バッジを自由に追加可能

#### 4.7 共有機能
* **共有 (iOS)**:
    * AirDropやLINEなどで、OS標準の「共有シート」を使い、名刺の公開URLを共有できる
    * PrivateCard交換時は、AirDropで有効期限付きトークンURLを送信
* **アプリ連携**:
    * 共有されたURLをタップした際、アプリがインストールされていればアプリが起動し、なければWebページが開く (Universal Links)

---

## 基本設計書

### 1. 全体アーキテクチャ
**Firebaseを中心としたサーバーレスアーキテクチャ**を採用する。
iOSアプリは認証と共有の起点、Web (Next.js) は公開閲覧、Cloud Functionsはバックエンドロジック全体を担当する。

### 2. バックエンド (Cloud Functions)
* **言語:** **TypeScript**
* **設計:** 3層レイヤードアーキテクチャ (Application, Domain, Infrastructure) を採用。Mapper層は省略し、Infrastructure (Repository) がデータ変換を兼任する。
* **主な関数:**
    * `Authトリガー (onCreate)`: Firebase Authでのユーザー登録をトリガーに、Firestoreの `/users` に非公開プロフィールを作成する。
    * `HTTPトリガー (onCall)` - `manualSync`: iOSアプリの「手動同期ボタン」から呼び出され、そのユーザーの外部サービス情報を即時同期する。
    * `HTTPトリガー (onCall)` - `saveCustomCss`: iOSアプリからカスタムCSSを受け取り、サニタイズ（無害化）処理を行なってから保存する。
    * `Scheduleトリガー (scheduledSync)`: Webhook実装までのフォールバック、およびWebhook非対応サービスの同期用として、全ユーザーのデータを定期実行（例: 1時間に1回）で同期する。

### 3. 認証 (Firebase Authentication)
* **役割:** アプリの認証基盤として利用。
* **プロバイダ:**
    * **Apple Sign In** (iOS App Store必須要件)
    * **Google Sign In**
    * **GitHub OAuth**
    * **X (Twitter) OAuth**
    * **Email/Password** (バックアップ用)

### 4. データベース (Cloud Firestore)
* **役割:** プライマリデータベース。
* **データ構造:** セキュリティを考慮し、コレクションを明確に分離する。
    * **`/users/{userId}` (非公開コレクション)**
        * **目的:** ユーザー本人しか読み書きできない機密情報（OAuthトークン、CSSの下書き等）。
        * **ルール:** 本人のみ読み書き可。
    * **`/public_cards/{userId}` (公開コレクション)**
        * **目的:** Webで「誰でも」閲覧可能な、サニタイズ済みの安全なデータ（公開プロフィール、記事一覧等）。
        * **ルール:** 読み取りは全員可、書き込みはCloud Functionsのみ可。
    * **`/private_cards/{userId}` (非公開コレクション)**
        * **目的:** 個人連絡先（メール、電話、LINE IDなど）。
        * **ルール:** 本人のみ読み書き可。
    * **`/private_card_tokens/{tokenId}` (トークンコレクション)**
        * **目的:** 1分間有効なPrivateCard交換用ワンタイムトークン。
        * **ルール:** 誰でも読み取り可（トークン検証用）、書き込みはCloud Functionsのみ可。
    * **`/events/{eventId}` (イベントコレクション)**
        * **目的:** イベント情報と参加者リスト。
        * **ルール:** 全員読み取り可、書き込みはCloud Functionsのみ可。
    * **`/users/{userId}/event_history/{eventId}` (サブコレクション)**
        * **目的:** ユーザーごとのイベント参加履歴と交換した名刺。
        * **ルール:** 本人のみ読み書き可。
    * **`/badges/{badgeId}` (バッジコレクション)**
        * **目的:** バッジの種類と画像情報。
        * **ルール:** 全員読み取り可、書き込みはCloud Functionsのみ可。
    * **`/users/{userId}/badges/{badgeId}` (サブコレクション)**
        * **目的:** ユーザーが取得したバッジと表示設定。
        * **ルール:** 本人のみ読み書き可。

### 5. ストレージ (Firebase Storage)
* **役割:** 画像ファイルの保存。
* **構造:**
    * **`/user_images/{userId}/profile.jpg`** - プロフィール画像
    * **`/user_images/{userId}/card_background.jpg`** - 名刺背景画像
    * **`/badge_images/{badgeId}.png`** - バッジ画像
* **セキュリティルール:**
    * アップロード: 本人のみ（user_images）、運営のみ（badge_images）
    * 読み取り: 全員可（公開画像として）

### 6. Webフロントエンド (Next.js)
* **技術:** **Next.js**
* **役割:** アプリの基本的な機能を全て提供するWebフロントエンド。
* **ホスティング:** **Firebase Hosting**
* **主要機能:**
    * **公開名刺の閲覧:** `https://devcard.com/username` のような公開名刺ページ。ログイン不要で誰でも閲覧可能。
    * **OGP対応:** サーバーサイドレンダリング (SSR) または静的サイト生成 (SSG) を利用し、LINEやX (Twitter) での**動的OGP（リッチプレビュー）**に対応する。
    * **ログイン:** Firebase Authenticationを使用した認証（Apple, Google, GitHub, X, Email/Password）。
    * **名刺管理（要ログイン）:**
        * PublicCard/PrivateCardの編集
        * 受け取った名刺の保存・管理
        * プロフィール画像・背景画像のアップロード
    * **イベント参加（要ログイン）:**
        * イベントへのチェックイン
        * 同じイベント参加者への名刺送信
        * イベント履歴の確認
    * **バッジ管理（要ログイン）:**
        * バッジの追加・配置
        * 認証バッジの表示
* **アクセス制御:**
    * **ログイン不要:** PublicCardの閲覧
    * **要ログイン:** 名刺の保存、イベント参加、プロフィール編集、画像アップロード

### 7. iOSアプリ (Swift / SwiftUI)
* **役割:** ユーザー認証、プロフィール編集、および共有機能の提供。
* **導入パッケージ (SPM):**
    * `Firebase/Auth`: 認証処理
    * `Firebase/Firestore`: `/users` コレクションの読み書き
    * `Firebase/Functions`: バックエンド関数 ( `manualSync` 等) の呼び出し
* **共有機能:**
    * **`UIActivityViewController` (共有シート)** を使用し、OS標準の共有機能（AirDrop, LINE等）で公開URLのみを共有する。`LinkPresentation`によるプレビューカスタマイズは必須としない。
* **アプリ連携:**
    * **`Universal Links` (ユニバーバルリンク)** を設定。公開URLがタップされた際、アプリインストール済みであればアプリが起動し、名刺追加等の処理に繋げる。
* **主要機能:**
    * **手動同期ボタン:** `Firebase/Functions` を介してバックエンドの `manualSync` 関数を呼び出し、プロフィールを即時更新する。
    * **PrivateCard交換:** AirDropまたはQRコードスキャンで有効期限付きトークンを送受信し、個人連絡先を交換する。

---

## 今後追加したい機能

### PrivateCard機能の拡張
- NFC/Bluetoothでの近距離通信交換
- 交換履歴の管理（いつ、誰と交換したか）
- 交換相手とのメモ機能

### PublicCardの機能拡張
- Qiita/Zenn連携
- 技術スタック（使用言語、フレームワーク）の表示
- アクティビティタイムライン（最近の投稿、コミット等）
- カスタムテーマ（プリセット + CSS編集）

### 分析機能
- PublicCardの閲覧数
- PrivateCard交換数
- どのイベントで何人と交換したか

### イベント連携
- connpass/DoorkeeperなどのイベントAPIと連携
- イベント参加者一覧での名刺交換
- イベント限定の交換モード

### その他
- 名刺のバージョン管理（過去の名刺を保存）
- チーム/組織での一括管理
- 名刺テンプレート共有

# Security and Validation

このドキュメントは、DevCardバックエンドが絶対に壊してはいけない安全ラインを定義します。

## 入力バリデーション

### どこで行うべきか

**Handler層**（`handlers/`）で最初に行う。

UseCaseに到達する前に、不正な入力を弾く。

### 何を検証するか

- **型の正当性**: 文字列、数値、配列など
- **必須項目の存在**: `null`や`undefined`の許容範囲
- **形式の妥当性**: メールアドレス、URL、日付フォーマット
- **サイズ制限**: 文字列長、配列長、ファイルサイズ

### バリデーションエラーの返し方

- HTTPステータス: `400 Bad Request`
- エラーメッセージ: ユーザーが修正できる情報を返す
- **絶対にやってはいけない**: 内部実装の詳細を漏らす

## 認証と認可

### 認証 (Authentication)

**Firebase Auth**が担当。

Handler層で確認：
- アクセストークンの検証
- ユーザーIDの抽出

### 認可 (Authorization)

**UseCase層**で判断。

判断基準：
- このユーザーはこのリソースにアクセスできるか
- このユーザーはこの操作を実行できるか

例：
- 「他人のカードを削除する」→ ❌ 禁止
- 「自分の保存カードを取得する」→ ✅ 許可

### 権限不足時の返し方

- HTTPステータス: `403 Forbidden`
- エラーメッセージ: 権限がないことだけを伝える（理由は詳述しない）

## ログ出力の制約

### 絶対に出してはいけないもの

- **個人識別情報 (PII)**:
  - パスワード
  - メールアドレス（一部マスキングは可）
  - 電話番号
  - 住所
- **秘密トークン**:
  - APIキー
  - アクセストークン
  - リフレッシュトークン
  - 暗号鍵

### ログに残すべきもの

- **監査証跡**:
  - ユーザーID（識別子のみ）
  - 操作の種類（作成/更新/削除）
  - タイムスタンプ
  - 操作結果（成功/失敗）
- **エラー情報**:
  - エラーの種類
  - スタックトレース（本番環境では慎重に）

## 監査証跡として残すべきもの

### どこで記録するか

**UseCase層**で記録する。

ビジネス的に重要な操作の前後で記録。

### 何を記録するか

- **誰が**: ユーザーID
- **いつ**: タイムスタンプ
- **何を**: 操作の種類（例: `SAVE_CARD`, `DELETE_CARD`）
- **結果**: 成功/失敗、エラー理由

### どの形式で記録するか

- **構造化ログ**: JSON形式で記録
- **一貫性**: すべての監査ログは同じスキーマを使う

例：
```json
{
  "userId": "abc123",
  "action": "SAVE_CARD",
  "targetCardUserId": "def456",
  "timestamp": "2025-10-26T12:34:56Z",
  "result": "success"
}
```

## データ更新時の副作用

### 副作用とは

- メール通知
- プッシュ通知
- ジョブキューへの投入
- 外部APIへのWebhook送信

### 合意ルール

1. **UseCase内で副作用を呼び出す**
   - Handler層では呼ばない（テストしにくくなる）
   - Domain層では呼ばない（純粋性を保つ）

2. **副作用は明示的に**
   - 関数名に `andNotify`, `andEnqueue` などを含める
   - 副作用がないことがデフォルト

3. **副作用の失敗は本処理を止めない**
   - メール送信失敗 → ログに記録するが、カード保存は完了させる
   - リトライ可能な副作用はジョブキューに投げる

## セキュリティチェックリスト

新しい機能を追加する際、以下を確認：

- [ ] 入力バリデーションを実装した
- [ ] 認証を確認した（必要な場合）
- [ ] 認可を確認した（必要な場合）
- [ ] ログにPIIや秘密トークンが含まれない
- [ ] 監査証跡を記録した（重要な操作の場合）
- [ ] 副作用の失敗が本処理を止めない

---

**注意**: これらのルールは、システムの安全性と信頼性を保つための最低ラインです。

name: Contract Sync to Web Client

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€contracts/ã®å¤‰æ›´ã‚’Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆdevcard_nextjsï¼‰ã¸è‡ªå‹•åŒæœŸã—ã¾ã™ã€‚
# ãƒˆãƒªã‚¬ãƒ¼: develop ãƒ–ãƒ©ãƒ³ãƒã¸ã®PRãƒžãƒ¼ã‚¸æ™‚ï¼ˆcontracts/ å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰
# 1. PRä½œæˆï¼ˆå¥‘ç´„ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸï¼‰
# 2. Issueä½œæˆï¼ˆå®Ÿè£…æŒ‡ç¤ºï¼‰

on:
  push:
    branches:
      - develop
    paths:
      - 'contracts/**'

env:
  WEB_REPO: yutaro0915/devcard_nextjs

jobs:
  sync-to-web:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backend repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—ã®ãŸã‚

      - name: Get commit information
        id: commit_info
        run: |
          SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

      - name: Generate timestamp for branch name
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.WEB_REPO_TOKEN }}" | gh auth login --with-token

      - name: Check if dev/develop branch exists in web repo
        id: check_dev
        run: |
          if gh api repos/${{ env.WEB_REPO }}/git/ref/heads/develop >/dev/null 2>&1; then
            echo "base_branch=develop" >> $GITHUB_OUTPUT
            echo "âœ“ develop branch exists, using as base"
          elif gh api repos/${{ env.WEB_REPO }}/git/ref/heads/dev >/dev/null 2>&1; then
            echo "base_branch=dev" >> $GITHUB_OUTPUT
            echo "âœ“ dev branch exists, using as base"
          else
            echo "base_branch=main" >> $GITHUB_OUTPUT
            echo "âš  dev/develop branch not found, falling back to main"
          fi

      - name: Checkout web repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.WEB_REPO }}
          token: ${{ secrets.WEB_REPO_TOKEN }}
          ref: ${{ steps.check_dev.outputs.base_branch }}
          path: web-repo

      - name: Create sync branch
        id: branch
        working-directory: web-repo
        run: |
          BRANCH_NAME="sync/contracts/${{ steps.timestamp.outputs.timestamp }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
          git config user.name "DevCard Backend Bot"
          git config user.email "bot@devcard.example.com"

      - name: Sync contracts directory
        run: |
          # contracts/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¸¸ã”ã¨ã‚³ãƒ”ãƒ¼ï¼ˆå†…å®¹ã¯æ”¹å¤‰ã—ãªã„ï¼‰
          rm -rf web-repo/contracts/
          cp -r contracts/ web-repo/contracts/

      - name: Commit and push changes
        working-directory: web-repo
        run: |
          git add contracts/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "skip=true" >> $GITHUB_ENV
          else
            git commit -m "chore(contracts): sync from backend commit ${{ steps.commit_info.outputs.short_sha }}"
            git push origin "${{ steps.branch.outputs.branch_name }}"
          fi

      - name: Create PR body from .work/item.json
        if: env.skip != 'true'
        run: |
          if [ -f .work/item.json ]; then
            # JSONã‹ã‚‰æƒ…å ±æŠ½å‡º
            FEATURE_NAME=$(jq -r '.feature_name' .work/item.json)
            BREAKING=$(jq -r '.breaking_changes' .work/item.json)
            API_CHANGES=$(jq -r '.api_changes | map("- **\(.path)** (\(.method)): \(.details)") | join("\n")' .work/item.json)
            BACKEND_SHA=$(git rev-parse HEAD)

            cat > pr_body.txt <<EOF
          ## ðŸ”„ Backend Contracts Sync

          ã“ã®PRã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§æ›´æ–°ã•ã‚ŒãŸ \`contracts/\` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸åŒæœŸã™ã‚‹ã‚‚ã®ã§ã™ã€‚

          ### Feature
          **${FEATURE_NAME}**

          ### API Changes
          ${API_CHANGES}

          ### Breaking Changes
          ${BREAKING}

          ### Backend Commit
          - SHA: ${BACKEND_SHA}
          - Message:
          \`\`\`
          ${{ steps.commit_info.outputs.message }}
          \`\`\`

          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ã“ã®PRã‚’ãƒžãƒ¼ã‚¸ã—ã¦ contracts/ ã‚’åŒæœŸ
          2. Issue ã‚’ç¢ºèªã—ã¦å®Ÿè£…ä½œæ¥­ã‚’é–‹å§‹

          ---

          **âš ï¸ æ³¨æ„**: ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã§ã™ã€‚å†…å®¹ã‚’ç›´æŽ¥ç·¨é›†ã—ãªã„ã§ãã ã•ã„ã€‚
          EOF
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: .work/item.json ãŒãªã„å ´åˆã¯å¾“æ¥å½¢å¼
            cat > pr_body.txt <<'EOF'
          ã“ã®PRã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§æ›´æ–°ã•ã‚ŒãŸ \`contracts/\` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’Webã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸åŒæœŸã™ã‚‹ã‚‚ã®ã§ã™ã€‚

          ### å¯¾è±¡
          - \`contracts/API_CONTRACT.md\`
          - \`contracts/CHANGELOG.md\`
          - \`contracts/openapi.yaml\`

          ### èƒŒæ™¯
          - backend commit: ${{ steps.commit_info.outputs.sha }}
          - message:
          \`\`\`
          ${{ steps.commit_info.outputs.message }}
          \`\`\`

          ### æ³¨æ„
          - ã“ã‚Œã¯ä»•æ§˜æ›¸æ›´æ–°ã®åŒæœŸPRã§ã™ã€‚ãƒžãƒ¼ã‚¸å¾Œã€Issueã‚’ç¢ºèªã—ã¦å®Ÿè£…ä½œæ¥­ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚
          - ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã§ã™ã€‚å†…å®¹ã‚’ç›´æŽ¥ç·¨é›†ã—ãªã„ã§ãã ã•ã„ã€‚
          EOF
          fi

      - name: Create PR
        if: env.skip != 'true'
        id: create_pr
        run: |
          PR_URL=$(gh pr create \
            --repo ${{ env.WEB_REPO }} \
            --base ${{ steps.check_dev.outputs.base_branch }} \
            --head ${{ steps.branch.outputs.branch_name }} \
            --title "[contracts sync] Update API contracts from backend commit ${{ steps.commit_info.outputs.short_sha }}" \
            --body-file pr_body.txt)

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ“ Created PR: $PR_URL"

      - name: Create Issue body from .work/item.json
        if: env.skip != 'true'
        run: |
          if [ -f .work/item.json ]; then
            # JSONã‹ã‚‰æƒ…å ±æŠ½å‡º
            FEATURE_NAME=$(jq -r '.feature_name' .work/item.json)
            CLIENT_ITEMS=$(jq -r '.client_work_items | map("- [ ] \(.)") | join("\n")' .work/item.json)
            NOTES=$(jq -r '.notes_for_frontend' .work/item.json)
            BREAKING=$(jq -r '.breaking_changes' .work/item.json)
            API_CHANGES=$(jq -r '.api_changes | map("- **\(.path)** (\(.method)): \(.details)") | join("\n")' .work/item.json)
            BACKEND_SHA=$(git rev-parse HEAD)

            cat > issue_body.txt <<EOF
          # ðŸ”„ Backend Contract Update

          ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® \`contracts/\` ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

          ---

          ## ðŸ“‹ å¤‰æ›´æ¦‚è¦

          **Feature**: ${FEATURE_NAME}

          ### API Changes
          ${API_CHANGES}

          ---

          ## ðŸŽ¯ Webå´ã§å¿…è¦ãªå¯¾å¿œ

          ${CLIENT_ITEMS}

          ---

          ## âš ï¸ ç ´å£Šçš„å¤‰æ›´

          ${BREAKING}

          ---

          ## ðŸ“ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‘ã‘ãƒ¡ãƒ¢

          ${NOTES}

          ---

          ## ðŸ“š å‚è€ƒæƒ…å ±

          ### å¤‰æ›´ã®è©³ç´°
          - PR: #${{ steps.create_pr.outputs.pr_number }}
          - Backend Commit: ${BACKEND_SHA}
          - CHANGELOG: contracts/CHANGELOG.md å‚ç…§

          ### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - APIä»•æ§˜: contracts/API_CONTRACT.md
          - OpenAPI: contracts/openapi.yaml

          ---

          ## âœ… å®Œäº†æ¡ä»¶

          - [ ] contracts/ ã‚’developã«ãƒžãƒ¼ã‚¸
          - [ ] ä¸Šè¨˜ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å®Ÿè£…å®Œäº†
          - [ ] ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒ³ãƒˆé€šéŽ
          - [ ] å‹•ä½œç¢ºèªå®Œäº†
          EOF
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: .work/item.json ãŒãªã„å ´åˆã¯å¾“æ¥å½¢å¼
            cat > issue_body.txt <<'EOF'
          ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® \`contracts/\` ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

          ### å¯¾å¿œå†…å®¹
          - PR: #${{ steps.create_pr.outputs.pr_number }}
          - commit: ${{ steps.commit_info.outputs.sha }}
          - message:
          \`\`\`
          ${{ steps.commit_info.outputs.message }}
          \`\`\`

          ### æŒ‡ç¤º
          1. PRã‚’ç¢ºèªã—ã€\`contracts/\` ã‚’ãƒžãƒ¼ã‚¸ã€‚
          2. \`CHANGELOG.md\` ã‚’å‚ç…§ã—ã¦ã€å½±éŸ¿ç¯„å›²ã‚’æ•´ç†ã€‚
          3. æ–°ã—ã„featureãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆï¼ˆä¾‹: \`feature/reflect-contract-${{ steps.commit_info.outputs.short_sha }}\`ï¼‰ã€‚
          4. å¿…è¦ãªUI/APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ã‚’è¡Œã„ã€PRã‚’ä½œæˆã€‚
          5. ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒ³ãƒˆé€šéŽã‚’ç¢ºèªå¾Œã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã€‚

          ### å‚™è€ƒ
          - ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã§ã™ã€‚
          - å¥‘ç´„ã®å”¯ä¸€ã®æ­£ã¯ \`contracts/\` ã§ã™ã€‚å†…å®¹ã‚’å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚
          EOF
          fi

      - name: Create Issue
        if: env.skip != 'true'
        id: create_issue
        run: |
          ISSUE_URL=$(gh issue create \
            --repo ${{ env.WEB_REPO }} \
            --title "[feature request] Reflect backend contract changes â€“ commit ${{ steps.commit_info.outputs.short_sha }}" \
            --body-file issue_body.txt)

          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "âœ“ Created Issue: $ISSUE_URL"

      - name: Summary
        if: env.skip != 'true'
        run: |
          echo "## Contract Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Synced contracts/ to ${{ env.WEB_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue**: ${{ steps.create_issue.outputs.issue_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base**: ${{ steps.check_dev.outputs.base_branch }}" >> $GITHUB_STEP_SUMMARY

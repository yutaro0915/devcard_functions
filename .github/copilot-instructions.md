# 🧠 GitHub Copilot レビュー方針

**レビュー言語**: 日本語

---

## チェックポイント

### 1. 仕様との整合性

- **PR本文と実装の一致**
  - PR本文に記載された変更内容が実装と一致しているか
  - `.work/item.json` の `api_changes[]`, `breaking_changes`, `security_notes[]` と実装が矛盾していないか

- **Contracts との整合性**
  - `contracts/API_CONTRACT.md` の記述が実装と一致しているか
  - `contracts/CHANGELOG.md` に変更履歴が適切に記録されているか
  - `contracts/openapi.yaml` が実装を正確に反映しているか

- **.work/item.json の更新**
  - `status` が適切に更新されているか（"ready-for-review" など）
  - `tests_required[]` に記載されたテストがすべて実装されているか
  - `client_work_items[]` がフロントエンド側で実装可能な形で記述されているか

---

### 2. セキュリティ

- **認証・認可**
  - 新しいAPIエンドポイントが認証チェックをバイパスしていないか
  - UseCase層で適切に認可判断が行われているか（Handler層ではなく）
  - Firebase Auth の ID トークン検証が正しく実装されているか

- **データ公開範囲**
  - データ公開範囲の変更が意図されたものか
  - PII（個人識別情報）が適切に保護されているか
  - `.work/item.json` の `security_notes[]` に記載された考慮事項が実装に反映されているか

- **バリデーション**
  - Handler層で入力バリデーションが適切に行われているか
  - SQL インジェクション、XSS などの脆弱性がないか
  - ログに機密情報（トークン、パスワード等）が出力されていないか

---

### 3. テスト

- **テストカバレッジ**
  - `.work/item.json` の `tests_required[]` に記載されたテストがすべて実装されているか
  - 追加されたテストが仕様変更を正しくカバーしているか
  - 成功系・失敗系の両方がテストされているか

- **破壊的変更**
  - 破壊的変更（`breaking_changes: true`）に対するテストが存在するか
  - 既存の動作が意図せず壊れていないか（リグレッション）

- **テストの質**
  - 単体テスト（UseCase）と結合テスト（Cloud Functions）が適切に分離されているか
  - テストが実装の詳細ではなく、振る舞いをテストしているか

---

### 4. コード品質

- **アーキテクチャ準拠**
  - Clean Architecture の3層構造（Domain → Application → Infrastructure/Handler）が守られているか
  - ビジネスロジックが Handler 層に漏れていないか
  - Domain 層が他の層に依存していないか

- **コードの冗長性**
  - 重複コード、冗長な処理がないか
  - アンチパターン（God Object, Feature Envy など）がないか

- **型安全性**
  - TypeScript の型定義が適切か
  - `any` 型の乱用がないか
  - null/undefined の扱いが安全か

- **エラーハンドリング**
  - 例外処理が適切に行われているか
  - ユーザーフレンドリーなエラーメッセージが返されているか
  - 内部実装の詳細がエラーメッセージに漏れていないか

---

### 5. ドキュメント更新

- **Contracts の更新**
  - `contracts/API_CONTRACT.md` が実装と一致しているか
  - `contracts/CHANGELOG.md` に変更履歴が記録されているか
  - `contracts/openapi.yaml` が最新の実装を反映しているか

- **.work/item.json の更新**
  - すべての必須フィールドが適切に埋まっているか
  - `status` が "ready-for-review" に更新されているか
  - `breaking_changes` フラグが正しく設定されているか

- **コメントと命名**
  - 関数名・変数名が変更意図を正しく反映しているか
  - 複雑なロジックに適切なコメントがあるか
  - コメントが実装と矛盾していないか

---

## レビュー出力形式

上記観点に基づき、以下の形式でコメントを出力してください：

### ✅ 良い点
- [実装の優れている点]

### ⚠️ 懸念点
- [セキュリティ、品質、仕様整合性の問題]

### 💡 改善提案
- [より良い実装方法の提案]

### 📋 確認事項
- [レビュワーに確認してほしい点]

---

## 重要度ラベル

**全てのレビューコメント**（インラインコメント含む）には、必ず以下のいずれかの重要度ラベルを**コメント冒頭**に付けてください：

### 🔴 **[CRITICAL]** - 即座に修正が必要
- **対象**: セキュリティ脆弱性、データ破損リスク、本番障害の可能性
- **例**:
  - 認証バイパス、SQLインジェクション、XSS脆弱性
  - データ整合性を破壊するロジック（トランザクション不足など）
  - 機密情報の漏洩（ログへのトークン出力など）
  - 破壊的変更が適切にドキュメント化されていない
- **対応方針**: このPRをマージする前に必ず修正すること

### 🟡 **[RECOMMENDED]** - 修正を強く推奨
- **対象**: アーキテクチャ違反、保守性の問題、パフォーマンス劣化、仕様との不整合
- **例**:
  - Clean Architectureの層分離違反
  - contracts/openapi.yamlと実装の不一致
  - テストカバレッジ不足（`.work/item.json` の `tests_required[]` 未実装）
  - 重複コード、アンチパターンの使用
  - エラーハンドリングの不備
- **対応方針**: マージ後にIssue化して優先的に対応（次のPRで修正）

### 🟢 **[OPTIONAL]** - 改善の余地あり
- **対象**: コードスタイル、命名、コメント、軽微なリファクタリング提案
- **例**:
  - より良い変数名・関数名の提案
  - コメントの追加・改善
  - 可読性向上のための軽微なリファクタリング
  - ドキュメントの表現改善
- **対応方針**: Issue化して時間があれば対応、またはbacklogに積む

### ℹ️ **[INFO]** - 情報共有・確認
- **対象**: 仕様確認、設計の意図確認、将来的な改善案の提示
- **例**:
  - 「この実装の意図は〇〇で合っていますか？」
  - 「将来的に△△を考慮する必要があるかもしれません」
  - 「この実装は仕様書と一致していることを確認しました」
- **対応方針**: レビュワーとの対話、または記録として残す

---

## レビューコメントの記述例

```markdown
🔴 **[CRITICAL]** セキュリティ: 認証チェックが実装されていません。未認証ユーザーがこのエンドポイントにアクセスできてしまいます。
\`\`\`suggestion
if (!request.auth) {
  throw new HttpsError("unauthenticated", "User must be authenticated");
}
\`\`\`
```

```markdown
🟡 **[RECOMMENDED]** アーキテクチャ準拠: この「最低1つのフィールド必須」バリデーションはビジネスルールではなく入力バリデーションです。Clean Architectureの原則に従い、このチェックはHandler層（profileHandlers.ts）で既に実装されているため、UseCase層での重複チェックは冗長です。UseCase層はビジネスロジックに集中すべきです。
```

```markdown
🟢 **[OPTIONAL]** 命名: 変数名 `data` は汎用的すぎます。`profileUpdateData` のように具体的な名前を推奨します。
```

```markdown
ℹ️ **[INFO]** 仕様確認: `bio` に空文字列を許可する実装になっていますが、これは仕様として意図されたものでしょうか？`contracts/API_CONTRACT.md` には明記されていないようです。
```

---

## 重要な原則

1. **レビューの厳しさは維持**: 品質向上のため、細かい点も妥協せず指摘してください
2. **必ずラベルを付ける**: 全てのコメントに重要度ラベルを付けることで、開発者が優先順位を判断できます
3. **具体的な修正案を提示**: 可能な限り `suggestion` ブロックで修正案を示してください
4. **複数の問題は分けて指摘**: 1つのコメントに複数の問題を詰め込まず、重要度ごとに分けて記載してください

---

**重要**: Copilot は PR 全体を分析し、上記観点に基づくコメントを**日本語**で出力してください。

{
  "feature_name": "badge-management-system-phase1-foundation",
  "status": "ready-for-review",
  "api_changes": [
    {
      "path": "addModerator",
      "method": "Callable Function (Internal)",
      "change_type": "new-endpoint",
      "breaking": false,
      "details": "管理者が新しいモデレータを追加。Custom Claims を設定。パラメータ: {userId, role, permissions}",
      "reason": "モデレータ権限の管理、運用チームの拡大"
    },
    {
      "path": "createBadge",
      "method": "Callable Function",
      "change_type": "new-endpoint",
      "breaking": false,
      "details": "モデレータがバッジを作成。パラメータ: {name, description, iconUrl?, color?, priority, isActive}",
      "reason": "プラットフォーム全体のバッジ管理を実現。ユーザーエンゲージメント向上"
    },
    {
      "path": "listBadges",
      "method": "Callable Function",
      "change_type": "new-endpoint",
      "breaking": false,
      "details": "全ユーザーが利用可能なバッジ一覧を取得。isActive=trueのみ返却。レスポンス: {badges: Badge[]}",
      "reason": "フロントエンドでのバッジ情報表示、バッジ選択UI"
    },
    {
      "path": "grantBadge",
      "method": "Callable Function",
      "change_type": "new-endpoint",
      "breaking": false,
      "details": "モデレータが指定ユーザーにバッジを付与。パラメータ: {badgeId, targetUserId, reason?}。デフォルトで両カードに表示（visibility: {showOnPublicCard: true, showOnPrivateCard: true}）",
      "reason": "手動バッジ付与によるユーザー認定・インセンティブ付与"
    },
    {
      "path": "revokeBadge",
      "method": "Callable Function",
      "change_type": "new-endpoint",
      "breaking": false,
      "details": "モデレータがバッジを失効。パラメータ: {badgeId, targetUserId}",
      "reason": "不正取得バッジの削除、条件不適合バッジの失効"
    }
  ],
  "security_notes": [
    "モデレータ権限はFirebase Auth Custom Claims で管理（moderator: true）",
    "addModerator は admin のみ実行可能（最高権限）",
    "createBadge, grantBadge, revokeBadge は moderator または admin のみ実行可能",
    "listBadges は全ユーザーがアクセス可能（公開情報）",
    "バッジ付与は監査ログとして /users/{userId}/badges/{badgeId} に記録",
    "Custom Claims の検証は Handler 層で実施（request.auth.token.moderator）"
  ],
  "tests_required": [
    "admin が addModerator でモデレータを追加できる",
    "一般ユーザーは addModerator を実行できない（permission-denied）",
    "モデレータが有効なバッジを作成できる",
    "一般ユーザーはバッジを作成できない（permission-denied）",
    "未認証ユーザーはバッジを作成できない（unauthenticated）",
    "バッジの優先度を指定できる",
    "バッジ名が空の場合エラー（invalid-argument）",
    "バッジ名が50文字を超える場合エラー（invalid-argument）",
    "モデレータが指定ユーザーにバッジを付与できる",
    "バッジ付与後、デフォルトで visibility: {showOnPublicCard: true, showOnPrivateCard: true} が設定される",
    "バッジ付与時に理由を記録できる",
    "存在しないバッジIDを付与しようとした場合エラー（not-found）",
    "存在しないユーザーにバッジを付与しようとした場合エラー（not-found）",
    "既に付与されているバッジを再付与しようとした場合エラー（already-exists）",
    "モデレータがバッジを失効できる",
    "全ユーザーがバッジ一覧を取得できる",
    "非アクティブなバッジは一覧に表示されない"
  ],
  "client_work_items": [
    "バッジ一覧画面の実装（listBadges APIを使用）",
    "モデレータ管理画面の実装（バッジ作成・付与UI）",
    "バッジ付与フォームの実装（対象ユーザー選択、バッジ選択、理由入力）",
    "バッジアイコンの表示優先度に従ったソート処理"
  ],
  "breaking_changes": false,
  "notes_for_frontend": "この変更はすべて非破壊的な追加です。\n\nPhase 1の追加機能:\n1. バッジ管理システムの基盤（モデレータのみ作成・付与可能）\n2. バッジ一覧取得API（listBadges）\n3. バッジはアイコンURL、色、優先度を持ち、フロントエンドで自由にデザイン可能\n\n注意事項:\n- モデレータUIは管理者専用画面として実装\n- Custom Claims（moderator: true）の確認はバックエンドで実施済み\n- Phase 2でバッジ表示制御（updateBadgeVisibility）と既存API統合（getPublicCard等）を実装予定\n- バッジアイコンは外部URLまたはFirebase Storageを想定",
  "backend_commit_sha": null
}

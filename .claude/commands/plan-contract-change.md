# Command: /plan-contract-change

## 目的

API仕様の変更・追加を行う前に、**計画フェーズを強制的に実施**させるコマンド。
いきなりコードや契約ファイルを書き換えず、変更の妥当性を人間が判断できる状態を作る。

---

## あなた（Claude）がやるべきこと

### 1. 変更内容の整理

ユーザーから提示された変更要求に基づき、以下を明確化する：

- **対象エンドポイント**: どのAPIを変更/追加するのか
- **変更の種類**:
  - 新規エンドポイント追加
  - 既存エンドポイントの修正（フィールド追加・削除・型変更）
  - エラーパターンの追加・変更
  - 認証・認可ロジックの変更

### 2. 変更内容の文章化

以下の項目を**必ず**文章で記述する：

> **参照**: docs/DEVELOPMENT_PROCESS.md の「影響範囲を明文化する」セクション

#### Before / After
- **変更前**: 現在の仕様（リクエスト/レスポンス構造）
- **変更後**: 新しい仕様（具体的なJSON例を含む）

#### 影響範囲の分析
- **データベース**: Firestoreスキーマへの影響
- **バリデーション**: 新しいバリデーションルールの必要性（docs/SECURITY_AND_VALIDATION.md 参照）
- **認証・認可**: 権限要件の変更（docs/SECURITY_AND_VALIDATION.md 参照）
- **依存関係**: この変更に影響される既存のエンドポイント
- **アーキテクチャ**: どのレイヤーに影響するか（docs/BACKEND_ARCHITECTURE.md 参照）

#### 破壊的変更の有無
- Web/iOSクライアントへの影響
- マイグレーション戦略（必要な場合）
- **参照**: docs/CONTRIBUTION_RULES.md の「破壊的変更」セクション

### 3. 必要なテストケースの列挙

実装時に書くべきテストを**事前に**リストアップする：

#### 成功系テスト
- 正常なリクエストが成功すること
- レスポンス構造が期待通りであること

#### 失敗系テスト
- バリデーションエラーのパターン（必須フィールド、型エラー等）
- 認証エラー（未ログイン、権限不足等）
- リソース未存在エラー

### 4. .work/item.json の生成

> **参照**: docs/DEVELOPMENT_PROCESS.md の「.work/item.json の位置づけ」

上記1-3の分析結果を元に、`.work/item.json` を生成する：

1. `.work/item.json` が既に存在するか確認
   - 存在する → 既存内容を読み込み、更新
   - 存在しない → 新規作成

2. 以下のフィールドを埋める：
   - `feature_name`: この変更の名前（1行で）
   - `status`: "draft" に設定
   - `api_changes[]`: ステップ2の分析結果から
   - `tests_required[]`: ステップ3のテストケースから
   - `client_work_items[]`: 影響範囲分析から導出
   - `security_notes[]`: セキュリティ・認可の考慮事項
   - `breaking_changes`: true/false（破壊的変更の有無）
   - `notes_for_frontend`: フロントエンド開発者への自然言語指示
   - `backend_commit_sha`: null（マージ時に確定）

### 5. ドラフト案の提示

**まだコードもcontractsも直接いじらず**、以下の形式で提案する：

```markdown
## API変更計画ドラフト

### 概要
[変更の目的を1-2文で]

### 変更内容

#### Before
[現在の仕様]

#### After
[新しい仕様]

### 影響範囲
- データベース: [影響の有無と詳細]
- バリデーション: [追加・変更が必要なルール]
- 認証: [変更の有無]
- 依存エンドポイント: [影響を受ける既存API]

### 破壊的変更
- Web: [影響の有無]
- iOS: [影響の有無]
- マイグレーション: [必要な場合の戦略]

### テストケース

#### 成功系
1. [テストケース1]
2. [テストケース2]

#### 失敗系
1. [バリデーションエラー系]
2. [認証エラー系]
3. [リソースエラー系]

### 推奨事項
[この変更を進めるべきか、懸念点はあるか]
```

---

## 参照すべき情報

### 必須参照ドキュメント

以下のドキュメントを**必ず確認**してから計画を立てる：

1. **docs/DEVELOPMENT_PROCESS.md** - 開発の順序と哲学
2. **docs/BACKEND_ARCHITECTURE.md** - レイヤー構成と責務の境界
3. **docs/CONTRIBUTION_RULES.md** - やってはいけないこと、必須事項
4. **docs/SECURITY_AND_VALIDATION.md** - 安全性の境界線

### 契約ファイル

1. `contracts/API_CONTRACT.md` - 現在のAPI仕様
2. `contracts/CHANGELOG.md` - 過去の変更履歴
3. `contracts/openapi.yaml` - 機械可読な仕様（存在する場合）

### ユーザー提示情報

- ユーザーから提示された変更要求

---

## 禁止事項

> **参照**: docs/CONTRIBUTION_RULES.md および docs/DEVELOPMENT_PROCESS.md

このコマンド実行時は、以下を**絶対に行わない**：

- ❌ コードを直接書く・編集する（docs/DEVELOPMENT_PROCESS.md: いきなり実装しない）
- ❌ `contracts/` 配下のファイルを編集する（実装が「正」、契約はそれを記述する）
- ❌ テストコードを書く（計画フェーズでは書かない）
- ❌ 仕様を勝手に発明・拡張する
- ❌ 「実装します」と言って作業を進める

---

## 成功条件

以下がすべて満たされていること：

- ✅ 変更内容が明確に文章化されている
- ✅ 影響範囲が網羅的に分析されている
- ✅ 必要なテストケースが事前にリストアップされている
- ✅ ドラフト案がレビュー可能な形式で提示されている
- ✅ .work/item.json の内容案が提示されている
- ✅ ユーザーが「やる/やらない」を判断できる状態になっている

---

## 出力形式

以下の順序で出力すること：

### 1. API変更計画ドラフト

上記「ドラフト案」テンプレートに従って出力。
自由形式での説明は避け、構造化された形式を守る。

### 2. .work/item.json の内容案

```json
{
  "feature_name": "...",
  "status": "draft",
  "api_changes": [...],
  "tests_required": [...],
  "client_work_items": [...],
  "security_notes": [...],
  "breaking_changes": true/false,
  "notes_for_frontend": "...",
  "backend_commit_sha": null
}
```

### 3. 次のステップ

ユーザーに承認を求め、承認されたら `.work/item.json` として保存する準備ができていることを伝える。
